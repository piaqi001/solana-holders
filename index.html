<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Solana 多代币前 400 持仓查询</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  input { padding: 6px; width: 480px; margin-bottom: 10px; display: block; }
  button { padding: 6px 12px; margin-bottom: 20px; }
  h3 { margin-top: 40px; }
  .results-container { display: flex; justify-content: space-between; gap: 20px; }
  .token-column { flex: 1; overflow: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
  th { background-color: #f2f2f2; }
  a { color: inherit; text-decoration: underline; }
  .loading { font-style: italic; color: gray; margin-top: 10px; }
  .error { color: red; margin-top: 10px; }
  .color-1 { color: black; }
  .color-2 { color: blue; }
  .color-3 { color: red; }
  #timestamp { margin-top: 10px; font-size: 14px; font-style: italic; color: gray; }
</style>
</head>
<body>
  <h2>Solana 多代币前 400 持仓查询</h2>
  <!-- 输入与按钮 -->
  <input type="text" id="token1" placeholder="请输入第一个代币地址">
  <input type="text" id="token2" placeholder="请输入第二个代币地址">
  <input type="text" id="token3" placeholder="可选：第三个代币地址">
  <button onclick="handleQuery()">查询</button>
  <div id="loading" class="loading" style="display:none;"></div>
  <div class="results-container" id="results"></div>
  <div id="overlap-container"></div>
  <script>
    async function handleQuery() {
      document.getElementById("loading").style.display = "block";
      const t1 = document.getElementById("token1").value.trim();
      const t2 = document.getElementById("token2").value.trim();
      const t3 = document.getElementById("token3").value.trim();

      const tokens = [t1, t2, t3].filter(Boolean);
      const results = [];

      for (let token of tokens) {
        const res = await fetch(`/api/holders?tokenAddress=${token}`);
        const json = await res.json();
        results.push({ name: token.slice(0, 4), holders: json.data });
      }

      document.getElementById("loading").style.display = "none";
      renderResults(results);
      if (results.length === 2) showOverlapTable(results);
    }

    function renderResults(results) {
      const container = document.getElementById("results");
      container.innerHTML = results.map(token => `
        <div class="token-column">
          <h3>${token.name}</h3>
          <table>
            <thead><tr><th>地址</th><th>持仓%</th></tr></thead>
            <tbody>
              ${token.holders.map(h => `
                <tr>
                  <td><a href="https://solscan.io/account/${h.address}" target="_blank">${h.address}</a></td>
                  <td>${(h.percent || 0).toFixed(4)}%</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`).join('');
    }

    function showOverlapTable(tokenDataList) {
      const [tokenA, tokenB] = tokenDataList;
      const mapA = new Map(tokenA.holders.map(addr => [addr.address, addr]));
      const mapB = new Map(tokenB.holders.map(addr => [addr.address, addr]));

      const overlap = [];
      for (const [address, dataA] of mapA.entries()) {
        if (mapB.has(address)) {
          const dataB = mapB.get(address);
          overlap.push({
            address,
            percentA: dataA.percent || 0,
            percentB: dataB.percent || 0,
          });
        }
      }

      const container = document.getElementById("overlap-container");
      container.innerHTML = `
        <h3>重叠率统计（共 ${overlap.length} 个地址）</h3>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>地址</th>
              <th>${tokenA.name} 持仓%</th>
              <th>${tokenB.name} 持仓%</th>
            </tr>
          </thead>
          <tbody>
            ${overlap.map((row, i) => `
              <tr>
                <td>${i + 1}</td>
                <td><a href="https://solscan.io/account/${row.address}" target="_blank">${row.address}</a></td>
                <td>${row.percentA.toFixed(4)}%</td>
                <td>${row.percentB.toFixed(4)}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
  </script>
</body>
</html>